<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tasks - Study Tracker</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .task-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-item.dark-mode {
      background: #2d2d2d;
      color: white;
    }
    .task-text {
      flex: 1;
      margin-right: 15px;
    }
    .delete-btn {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background: #cc0000;
    }
    .add-task-form {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .add-task-form.dark-mode {
      background: #2d2d2d;
      color: white;
    }
  </style>
</head>
<body class="light-mode">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-tasks"></i> My Tasks</h2>
      <div>
        <a href="dashboard.html" class="btn btn-outline-primary me-2">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <button class="btn btn-outline-dark" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i> Dark Mode
        </button>
      </div>
    </div>

    <!-- Add Task Form -->
    <div class="add-task-form">
      <h4>Add New Task</h4>
      <form id="addTaskForm">
        <div class="mb-3">
          <label class="form-label">Task Description</label>
          <input type="text" class="form-control" id="taskInput" placeholder="Enter your task..." required>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Task
        </button>
      </form>
    </div>

    <!-- Tasks List -->
    <div id="tasksList">
      <h4>Your Tasks</h4>
      <div id="tasksContainer">
        <!-- Tasks will be displayed here -->
      </div>
    </div>
  </div>

  <script src="js/script.js"></script>
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      document.body.classList.toggle("light-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update task items
      const taskItems = document.querySelectorAll('.task-item');
      taskItems.forEach(item => {
        item.classList.toggle("dark-mode");
      });
      
      // Update form
      const form = document.querySelector('.add-task-form');
      if (form) form.classList.toggle("dark-mode");
      
      const btn = document.querySelector('button[onclick="toggleDarkMode()"]');
      if (btn) {
        btn.innerHTML = isDark 
          ? '<i class="fas fa-sun"></i> Light Mode' 
          : '<i class="fas fa-moon"></i> Dark Mode';
      }
    }
    
    // Load saved theme
    window.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.body.classList.remove('light-mode');
        const taskItems = document.querySelectorAll('.task-item');
        taskItems.forEach(item => item.classList.add("dark-mode"));
        const form = document.querySelector('.add-task-form');
        if (form) form.classList.add("dark-mode");
        const btn = document.querySelector('button[onclick="toggleDarkMode()"]');
        if (btn) btn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
      }
    });

    function loadTasks() {
      const token = localStorage.getItem("authToken");
      if (!token) {
        location.href = "login.html";
        return;
      }

      fetch('/api/data', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        const tasks = data.data.tasks || [];
        displayTasks(tasks);
      })
      .catch(err => {
        console.error('Failed to load tasks:', err);
        displayTasks([]);
      });
    }

    function displayTasks(tasks) {
      const container = document.getElementById('tasksContainer');
      
      if (tasks.length === 0) {
        container.innerHTML = '<p class="text-muted">No tasks yet. Add your first task above!</p>';
        return;
      }

      container.innerHTML = tasks.map((task, index) => `
        <div class="task-item">
          <div class="task-text">${task}</div>
          <button class="delete-btn" onclick="deleteTask(${index})">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      `).join('');
    }

    function addTask(taskText) {
      const token = localStorage.getItem("authToken");
      if (!token) return;

      fetch('/api/data', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        const tasks = data.data.tasks || [];
        tasks.push(taskText);
        
        return fetch('/api/data', {
          method: 'POST',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tasks })
        });
      })
      .then(() => {
        loadTasks(); // Reload tasks
        document.getElementById('taskInput').value = '';
      })
      .catch(err => {
        console.error('Failed to add task:', err);
        alert('Failed to add task. Please try again.');
      });
    }

    function deleteTask(index) {
      const token = localStorage.getItem("authToken");
      if (!token) return;

      fetch('/api/data', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        const tasks = data.data.tasks || [];
        tasks.splice(index, 1);
        
        return fetch('/api/data', {
          method: 'POST',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tasks })
        });
      })
      .then(() => {
        loadTasks(); // Reload tasks
      })
      .catch(err => {
        console.error('Failed to delete task:', err);
        alert('Failed to delete task. Please try again.');
      });
    }

    // Event listeners
    document.getElementById('addTaskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const taskText = document.getElementById('taskInput').value.trim();
      if (taskText) {
        addTask(taskText);
      }
    });

    // Load tasks on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadTasks();
    });
  </script>
</body>
</html>
