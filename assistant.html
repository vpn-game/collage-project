<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Assistant</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f8ff; margin: 0; }
    header { background:#4CAF50; color:#fff; padding:12px 16px; text-align:center; position:sticky; top:0 }
    .container { max-width: 900px; margin: 16px auto; padding: 0 12px; }
    .chat { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; }
    .chat-header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:8px; }
    .chat-body { height: 60vh; overflow-y:auto; padding: 16px; display:flex; flex-direction:column; gap:10px; background:#fafcff; }
    .msg { max-width: 80%; padding:10px 12px; border-radius:10px; line-height:1.35; font-size:15px; }
    .msg.user { align-self:flex-end; background:#e8f5e9; }
    .msg.bot { align-self:flex-start; background:#f1f3f5; }
    .chat-input { display:flex; gap:8px; padding:12px; border-top:1px solid #eee; background:#fff; }
    .chat-input input { flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
    .chat-input button { background:#4CAF50; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .hint { color:#666; font-size:12px; margin-top:6px; }
    .back { position:absolute; left:12px; top:12px; background:transparent; color:#fff; border:none; font-size:14px; cursor:pointer; }
    body.dark-mode { background:#1a1a1a; color:#f0f0f0; }
    body.dark-mode .chat { background:#2b2b2b; }
    body.dark-mode .chat-body { background:#232323; }
    body.dark-mode .msg.user { background:#214d25; color:#e9ffe9 }
    body.dark-mode .msg.bot { background:#303030; color:#f0f0f0 }
    body.dark-mode .chat-input input { background:#1f1f1f; border-color:#3a3a3a; color:#f0f0f0 }
    body.dark-mode .chat-input { background:#2b2b2b; }
  </style>
  <script>
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') document.body.classList.add('dark-mode');
    }
  </script>
</head>
<body onload="loadTheme()">
  <header>
    <button class="back" onclick="location.href='dashboard.html'"><i class="fa fa-arrow-left"></i> Back</button>
    ðŸ¤– AI Assistant
  </header>
  <div class="container">
    <div class="chat" id="chat">
      <div class="chat-header"><i class="fa fa-robot"></i> Ask anything about your study tracker</div>
      <div class="chat-body" id="chatBody">
        <div class="msg bot">Hi! I am your assistant. Ask me about notes, tasks, login, or anything else.</div>
      </div>
      <div class="chat-input">
        <input id="userInput" type="text" placeholder="Type your message and press Enter..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
    <div class="hint">Quick actions: <button id="qaIdeas">Ideas</button> <button id="qaNotes">Notes</button> <button id="qaSummary">Summary</button> <button id="qaYoutube">YouTube</button></div>
  </div>

  <script>
    const chatBody = document.getElementById('chatBody');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const API_BASE = (location.protocol === 'file:') ? 'http://localhost:4000' : '';

    const history = [];
    function appendMessage(text, role, html = false) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      if (html) {
        div.innerHTML = text;
      } else {
        div.textContent = text;
      }
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
      history.push({ role, content: text });
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      appendMessage(text, 'user');
      input.value = '';
      try {
        const res = await fetch(API_BASE + '/api/assistant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history })
        });
        const data = await res.json();
        let reply = data.reply || 'Sorry, I could not respond.';
        if (data.links && Array.isArray(data.links)) {
          const linksHtml = data.links.map(l => `<div><a href="${l.url}" target="_blank" rel="noopener noreferrer">${l.title}</a></div>`).join('');
          const extra = data.extraQueries ? `<div style="margin-top:6px; white-space:pre-wrap;">${data.extraQueries}</div>` : '';
          appendMessage(`<div>${escapeHtml(reply).replace(/\n/g,'<br>')}</div>${linksHtml}${extra}`, 'bot', true);
        } else {
          appendMessage(reply, 'bot');
        }
      } catch (e) {
        appendMessage('Network error. Please try again.', 'bot');
      }
    }

    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
    sendBtn.addEventListener('click', sendMessage);

    // Quick actions
    function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    document.getElementById('qaIdeas').addEventListener('click', async () => {
      const topic = prompt('Topic for ideas?');
      if (!topic) return;
      appendMessage(`Ideas for: ${topic}`, 'user');
      const res = await fetch(API_BASE + '/api/assistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'ideas', topic, history }) });
      const data = await res.json();
      appendMessage(data.reply || 'No response', 'bot');
    });
    document.getElementById('qaNotes').addEventListener('click', async () => {
      const topic = prompt('Topic for notes?');
      if (!topic) return;
      appendMessage(`Notes on: ${topic}`, 'user');
      const res = await fetch(API_BASE + '/api/assistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'notes', topic, history }) });
      const data = await res.json();
      appendMessage(data.reply || 'No response', 'bot');
    });
    document.getElementById('qaSummary').addEventListener('click', async () => {
      const text = prompt('Paste text to summarize:');
      if (!text) return;
      appendMessage('Summarize this text', 'user');
      const res = await fetch(API_BASE + '/api/assistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'summary', text, history }) });
      const data = await res.json();
      appendMessage(data.reply || 'No response', 'bot');
    });
    document.getElementById('qaYoutube').addEventListener('click', async () => {
      const topic = prompt('Topic to search on YouTube?');
      if (!topic) return;
      appendMessage(`YouTube links for: ${topic}`, 'user');
      const res = await fetch(API_BASE + '/api/assistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'youtube', topic, history }) });
      const data = await res.json();
      let reply = data.reply || 'No response';
      if (data.links && Array.isArray(data.links)) {
        const linksHtml = data.links.map(l => `<div><a href="${l.url}" target="_blank" rel="noopener noreferrer">${l.title}</a></div>`).join('');
        const extra = data.extraQueries ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(data.extraQueries)}</div>` : '';
        appendMessage(`<div>${escapeHtml(reply)}</div>${linksHtml}${extra}`, 'bot', true);
      } else {
        appendMessage(reply, 'bot');
      }
    });
  </script>
</body>
</html>


